# CI/CD Overview

This repository now relies on four GitHub Actions workflows that cover pull request
validation, documentation checks, release automation, and triage labelling. Each
workflow is scoped to the minimum set of triggers and permissions required to keep
maintenance low while preserving prior functionality such as Docker image builds and
security reporting.

## Workflow inventory

| Workflow | Purpose | Triggers | Health |
| --- | --- | --- | --- |
| [`ci.yml`](../../.github/workflows/ci.yml) | Change-aware linting, tests, package builds, and dependency/code scanning | Push/PR to `main` or `develop`, manual dispatch | ✅ Active |
| [`config-deployment.yml`](../../.github/workflows/config-deployment.yml) | Detect configuration diffs and validate templates/compose manifests | Push/PR touching config/docker compose, manual dispatch | ✅ Active |
| [`docs.yml`](../../.github/workflows/docs.yml) | MkDocs build and documentation validation | Push/PR touching docs or Markdown, manual dispatch | ✅ Active |
| [`release.yml`](../../.github/workflows/release.yml) | Validated releases with dist builds, GHCR image publishing, security report, and PyPI publish | Tag push `v*.*.*`, manual dispatch with existing tag | ✅ Active |
| [`test-composite-actions.yml`](../../.github/workflows/test-composite-actions.yml) | Regression suite for local composite actions such as setup and config validation | Pull requests/workflow dispatch touching composite actions or helpers | ✅ Active |
| [`labeler.yml`](../../.github/workflows/labeler.yml) | Apply file, size, and keyword labels to PRs/issues and auto-assign reviewers | PR/issue events | ✅ Active |

### Retired workflows

The following legacy workflows remain removed because they were unused, redundant with
CI, or simulated deployments:

- `core-ci.yml`
- `regression-opt-in.yml`
- `security-opt-in.yml`
- `stale.yml`
- `zero-maintenance-automation.yml`
- `.github/workflows/shared/*`

## CI pipeline (`ci.yml`)

**Jobs**

- `changes`: uses `dorny/paths-filter` to determine whether source, dependency,
  workflow, or test files changed.
- `lint`: runs Ruff format checks, Ruff linting, Pylint (score ≥9.5), and Pyright when
  code, config, dependency, or workflow changes occur.
- `tests`: executes `python scripts/dev.py test --profile ci`, uploads coverage, and
  reports to Codecov when applicable.
- `build`: produces wheels/sdists via `uv build` and validates metadata with Twine.
- `audit`: installs `pip-audit` and `bandit`, emitting JSON reports for dependency and
  code scans.

**Key settings**

- Concurrency is limited to one run per ref with cancellation for fast feedback.
- Composite actions `.github/actions/checkout-and-setup` and
  `.github/actions/setup-environment` handle checkout plus uv installation and caching
  for consistent environments.
- Artifacts (coverage, distributions, and security reports) are retained for 7 days.
- Conditional job execution avoids rerunning expensive jobs for doc-only changes.

## Configuration validation workflow (`config-deployment.yml`)

- `detect-config-changes` uses `dorny/paths-filter` to short-circuit when no configuration files move.
- `validate-config` reuses the shared environment setup, invokes the composite config validator, and verifies docker compose manifests when templates change.
- Manual dispatch accepts an optional environment input to prioritize template validation during incident response.

## Documentation workflow (`docs.yml`)

- Installs only the `docs` dependency group via uv.
- Runs the documentation validation helper and performs a strict MkDocs build.
- Shares the same concurrency pattern as CI to prevent overlapping builds.

## Release workflow (`release.yml`)

- `prepare` validates the tag or dispatch input, detects Docker targets, and marks
  prereleases.
- `quality` checks out the tagged ref, re-runs linting, type checking, and the CI test
  profile before artifacts are produced.
- `build-artifacts` aligns the `pyproject.toml` version with the tag, builds sdists and
  wheels, and uploads them for reuse.
- `publish-docker` pushes the worker image to GHCR (when configured) and publishes an
  SBOM via `anchore/sbom-action`.
- `security-report` rebuilds the uv environment and generates a combined
  `pip-audit`/Bandit Markdown report.
- `github-release` assembles all artifacts (dists, SBOM, security report) and creates a
  GitHub release with autogenerated notes.
- `publish-pypi` pushes to PyPI using `pypa/gh-action-pypi-publish` when a token is
  configured and the release is not a prerelease.

## Composite action regression (`test-composite-actions.yml`)

- Exercises the setup and validation composite actions on pull requests that modify `.github/actions/**` or helper scripts.
- Generates disposable fixtures to confirm the validators detect good versus bad configuration payloads.
- Acts as the safety net for local action changes so the core CI workflow stays lean.

## Labeler (`labeler.yml`)

- File-based labels from `.github/labeler.yml` remain in sync via `actions/labeler` with
  `sync-labels: true`.
- PRs receive size labels, conventional commit keyword labels, and are auto-assigned to
  the author while requesting a maintainer review when the submitter differs from the
  repository owner.
- Issues are tagged with `needs-triage` and lightly classified into `bug`,
  `enhancement`, `documentation`, or `question` based on simple keyword matching.

## Migration summary

- Restored change detection, Codecov uploads, and security reporting that were removed
  in the prior simplification while keeping redundant jobs deleted.
- Retained the dedicated configuration validation and composite-action regression
  workflows so custom actions stay covered without bloating the main CI pipeline.
- Release automation once again updates package metadata, publishes GHCR images, and
  attaches SBOM/security artifacts without relying on large inline bash blocks.
- Label automation now mirrors the previous behaviour (file/size/keyword labels and
  reviewer assignment) using maintained actions with reduced custom logic.
- Shared matrix/cache config files remain unnecessary because all workflows use the
  maintained composite action for environment setup.

## Local guidance

Before opening a pull request, run the same commands that power CI:

```bash
uv run ruff format --check .
uv run ruff check .
uv run pylint --fail-under=9.5 src scripts
uv run pyright
uv run python scripts/dev.py test --profile ci
uv build
```

MkDocs contributors can run:

```bash
uv sync --frozen --group docs
uv run python scripts/dev.py validate --check-docs --strict
uv run mkdocs build --strict
```
